# AI视频大师调试经验总结

## 1. API调用问题

### DashScope API参数错误

**问题**：使用DashScope API进行语音识别时出现参数错误。

**解决方案**：
- 确保API调用使用正确的参数格式，特别是在更新后的API版本中
- 对于录音文件识别，使用`file_urls`参数传递列表而非`file_path`
- 直接传递参数而非通过params字典嵌套传递

**关键经验**：
- 第三方API可能会有不兼容更新，需要关注版本变化
- 对于关键依赖库，保持API文档更新并进行版本检测

### DashScope录音文件识别API实现

**问题**：不清楚如何正确使用DashScope的录音文件识别API。

**解决方案**：
- 区分实时语音识别和录音文件识别API的不同用途
- 录音文件识别：支持OSS URL识别，使用`Transcription.call`方法
- 实时语音识别：支持本地文件，需要回调机制，使用`Recognition`类

**关键经验**：
- 准确理解API文档对不同场景的建议用法
- 为没有OSS的环境提供备选方案（如file_content直接发送）

### DashScope FILE_DOWNLOAD_FAILED错误处理

**问题**：DashScope API无法下载本地通过`_create_local_accessible_url`生成的URL。

**解决方案**：
- 实现多层备选方案：
  1. 优先使用OSS上传获取公网可访问URL
  2. 如OSS不可用，使用file_content参数直接发送文件内容
  3. 对于大文件可转换为标准格式后再尝试

**关键经验**：
- DashScope需要公网访问音频文件，本地file://协议通常不可用
- 多层备选方案能显著提高系统稳定性

## 2. 文件管理问题

### 临时文件清理机制

**问题**：视频分析后产生的临时文件（下载的视频和音频）未被清理，导致磁盘空间浪费。

**解决方案**：
- 在视频分析完成后添加清理逻辑
- 为不同类型文件设置明确的存储位置和生命周期策略：
  - 临时视频：data/temp/videos/downloaded（处理后删除）
  - 音频缓存：data/cache/audio（可复用）
  - 字幕输出：data/processed/subtitles（永久保存）

**关键经验**：
- 区分临时文件与缓存文件的策略
- 添加文件操作的详细日志和结果验证

### 临时文件无法删除问题

**问题**：即使添加了清理代码，某些临时视频文件仍无法删除。

**解决方案**：
- 创建独立的清理脚本使用更底层的系统命令
- 使用`find`命令和`rm -f`进行强制删除
- 设置定期清理任务并记录清理结果

**关键经验**：
- 系统底层命令可能比高级语言API更有效
- 重要但非核心的维护任务应设计为独立机制

## 3. UI优化经验

### UI中状态显示重复问题

**问题**：视频处理过程中，状态文本和进度条显示重复信息，造成界面冗余。

**解决方案**：
- 进度条显示处理阶段信息，状态文本显示补充信息或置空
- 对于关键步骤，使用状态文本显示详细数据（如"识别了X条句子"）

**关键经验**：
- UI组件应提供互补而非重复的信息
- 进度条适合显示当前阶段，状态文本适合显示补充信息

## 4. 视频处理问题

### VideoProcessor方法调用错误

**问题**：直接使用类名调用方法导致"VideoProcessor has no attribute 'get_video_info'"错误。

**解决方案**：
- 创建VideoProcessor实例并使用实例方法，而非错误地使用类方法
- 使用正确的方法名（注意下划线前缀的私有方法）

**关键经验**：
- 注意区分实例方法和类方法
- 下划线前缀方法通常表示私有/内部方法，应谨慎调用

### 音频提取和字幕生成功能

**问题**：视频处理流程中音频提取成功但字幕生成失败。

**解决方案**：
- 完善文件路径处理和存储位置验证
- 增强API调用的错误捕获和日志记录
- 添加对字幕文件保存结果的验证

**关键经验**：
- 音频处理是一个多步骤流程，每步都应有明确的结果验证
- 对关键环节增加状态记录和校验点

## 5. 热词表使用经验

### 热词表应用与字幕提取质量

**问题**：如何正确应用热词表提高字幕识别准确率。

**解决方案**：
- 识别使用`vocab-aivideo-4d73bdb1b5ef496d94f5104a957c012b`等热词表ID
- 在`_extract_subtitles_from_video`方法中传递vocabulary_id参数
- 测试验证热词表在特定领域词汇识别的有效性

**关键经验**：
- 热词表能显著提高特定领域术语的识别准确率
- 不同视频内容可能需要不同的热词表

## 调试记录复杂度分级

根据时间投入和复杂度，问题修复可分为以下级别：
- **常规修复**（0.5-1小时）：简化记录，重点记录问题和解决方案
- **中等复杂度修复**（1-2小时）：标准记录，包含尝试过程和简要经验
- **重大修复**（2小时以上）：详细记录，全面背景、方案对比和教训

其他判断重要修复的标准：
- 代码影响范围（多个模块/文件，100行以上改动）
- 问题严重程度（核心功能阻断，数据安全问题）
- 解决方案复杂度（需深入理解底层原理）
- 小修复积累（同一问题超过3次小修复）

## 通用调试经验

1. **日志优化**：
   - 添加详细的处理流程日志，特别是API调用和文件处理结果
   - 为关键操作添加状态验证和错误捕获

2. **错误处理**：
   - 为外部依赖增加完整的异常捕获和详细错误记录
   - 增加多层备选方案以提高系统健壮性

3. **持续验证**：
   - 为各个处理环节添加单元测试和集成测试
   - 使用自动化脚本定期验证系统功能

4. **文件管理**：
   - 明确区分临时文件与缓存文件
   - 实现定期清理机制避免占用过多存储空间

## 关键词标签

#API优化 #文件管理 #错误处理 #UI优化 #视频处理 #语音识别 #热词表 #临时文件 #缓存策略 #系统健壮性
